<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Orders Management - TicTacBags Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0">
                <div class="admin-sidebar">
                    <!-- Admin Brand -->
                    <div class="text-center mb-4">
                        <h4 class="text-white fw-bold">
                            <i class="fas fa-shopping-bag me-2"></i>TicTacBags
                        </h4>
                        <p class="text-white-50 small mb-0">Admin Panel</p>
                    </div>

                    <!-- Admin User Info -->
                    <div class="text-center mb-4 pb-3 border-bottom border-secondary">
                        <div class="bg-white bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <h6 class="text-white mb-1">Administrator</h6>
                        <small class="text-white-50" id="loginTime"></small>
                    </div>

                    <!-- Navigation Menu -->
                    <ul class="admin-nav">
                        <li>
                            <a href="dashboard.html" class="active">
                                <i class="fas fa-tachometer-alt"></i>
                                Orders Management
                            </a>
                        </li>
                        <li>
                            <a href="products.html">
                                <i class="fas fa-box"></i>
                                Products Management
                            </a>
                        </li>
                        <li>
                            <a href="categories.html">
                                <i class="fas fa-list"></i>
                                Categories Management
                            </a>
                        </li>
                        <li>
                            <a href="brands.html">
                                <i class="fas fa-tags"></i>
                                Brands Management
                            </a>
                        </li>
                        <li>
                            <a href="banners.html">
                                <i class="fas fa-images"></i>
                                Banner Management
                            </a>
                        </li>
                        <li>
                            <a href="../index.html" target="_blank">
                                <i class="fas fa-external-link-alt"></i>
                                View Website
                            </a>
                        </li>
                        <li class="mt-4">
                            <a href="#" onclick="logout()" class="text-danger">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="admin-content">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="fw-bold text-dark">Orders Management</h1>
                            <p class="text-muted">Manage all customer orders and their status</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshOrders()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                            <button class="btn btn-success" onclick="exportOrders()">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Order Statistics -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="admin-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded p-3 me-3">
                                        <i class="fas fa-shopping-cart text-primary" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-1" id="totalOrders">0</h3>
                                        <p class="text-muted mb-0 small">Total Orders</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="admin-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning bg-opacity-10 rounded p-3 me-3">
                                        <i class="fas fa-clock text-warning" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-1" id="pendingOrders">0</h3>
                                        <p class="text-muted mb-0 small">Pending Orders</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="admin-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-opacity-10 rounded p-3 me-3">
                                        <i class="fas fa-truck text-success" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-1" id="shippedOrders">0</h3>
                                        <p class="text-muted mb-0 small">Shipped Orders</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="admin-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info bg-opacity-10 rounded p-3 me-3">
                                        <i class="fas fa-dollar-sign text-info" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                        <h3 class="fw-bold mb-1" id="totalRevenue">Rs 0</h3>
                                        <p class="text-muted mb-0 small">Total Revenue</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Filter -->
                    <div class="admin-card mb-4">
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div>
                                <label class="form-label small mb-1">Filter by Status:</label>
                                <select class="form-select form-select-sm" id="statusFilter" onchange="filterOrders()">
                                    <option value="">All Orders</option>
                                    <option value="pending">Pending</option>
                                    <option value="shipped">Shipped</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label small mb-1">Search Orders:</label>
                                <input type="text" class="form-control form-control-sm" id="searchOrders" placeholder="Order ID, Customer name..." onkeyup="searchOrders()">
                            </div>
                            <div>
                                <label class="form-label small mb-1">Date Range:</label>
                                <input type="date" class="form-control form-control-sm" id="dateFrom" onchange="filterOrders()">
                            </div>
                            <div class="align-self-end">
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Table -->
                    <div class="admin-card">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Payment</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <!-- Orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- No Orders Message -->
                        <div id="noOrdersMessage" class="text-center py-5 d-none">
                            <i class="fas fa-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                            <h5 class="text-muted">No orders found</h5>
                            <p class="text-muted">Orders will appear here when customers place them.</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Orders pagination" class="mt-4">
                        <ul class="pagination justify-content-center" id="ordersPagination">
                            <!-- Pagination will be loaded here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let orders = [];
        let filteredOrders = [];
        let currentPage = 1;
        const ordersPerPage = 10;

        // Check admin authentication
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadOrders();
            updateLoginTime();
        });

        function checkAdminAuth() {
            const loginData = localStorage.getItem('tictacbags_admin_login');
            if (!loginData) {
                window.location.href = 'index.html';
                return;
            }

            const data = JSON.parse(loginData);
            const now = new Date().getTime();
            const sessionDuration = data.rememberMe ? (24 * 60 * 60 * 1000) : (60 * 60 * 1000);
            
            if ((now - data.timestamp) > sessionDuration) {
                localStorage.removeItem('tictacbags_admin_login');
                window.location.href = 'index.html';
                return;
            }
        }

        function updateLoginTime() {
            const loginData = localStorage.getItem('tictacbags_admin_login');
            if (loginData) {
                const data = JSON.parse(loginData);
                const loginDate = new Date(data.timestamp);
                document.getElementById('loginTime').textContent = loginDate.toLocaleString();
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('tictacbags_admin_login');
                window.location.href = 'index.html';
            }
        }

        function loadOrders() {
            // Load orders from localStorage
            orders = JSON.parse(localStorage.getItem('tictacbags_orders')) || [];
            console.log('Loading orders from localStorage:', orders); // Debug log
            filteredOrders = [...orders];
            
            updateOrderStats();
            displayOrders();
            updatePagination();
        }

        function updateOrderStats() {
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(o => o.status === 'pending').length;
            const shippedOrders = orders.filter(o => o.status === 'shipped').length;
            const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);

            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('shippedOrders').textContent = shippedOrders;
            document.getElementById('totalRevenue').textContent = 'Rs ' + totalRevenue.toLocaleString();
        }

        function displayOrders() {
            const tbody = document.getElementById('ordersTableBody');
            const noOrdersMsg = document.getElementById('noOrdersMessage');
            
            if (filteredOrders.length === 0) {
                tbody.innerHTML = '';
                noOrdersMsg.classList.remove('d-none');
                return;
            }

            noOrdersMsg.classList.add('d-none');
            
            const startIndex = (currentPage - 1) * ordersPerPage;
            const endIndex = startIndex + ordersPerPage;
            const ordersToShow = filteredOrders.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            ordersToShow.forEach(order => {
                const row = document.createElement('tr');
                const orderDate = new Date(order.date).toLocaleDateString();
                const statusClass = getStatusClass(order.status);
                
                row.innerHTML = `
                    <td>
                        <strong>${order.id}</strong>
                    </td>
                    <td>
                        <div>
                            <div class="fw-bold">${order.customerName}</div>
                            <small class="text-muted">${order.email}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${order.items.length} items</span>
                    </td>
                    <td>
                        <strong>Rs ${order.total.toLocaleString()}</strong>
                    </td>
                    <td>
                        <span class="badge ${order.paymentMethod === 'cod' ? 'bg-warning' : 'bg-info'}">${order.paymentMethod.toUpperCase()}</span>
                    </td>
                    <td>
                        <span class="order-status ${statusClass}">${order.status}</span>
                    </td>
                    <td>
                        <small>${orderDate}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewOrderDetails('${order.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('${order.id}', 'pending')">
                                        <i class="fas fa-clock text-warning me-2"></i>Mark as Pending
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('${order.id}', 'shipped')">
                                        <i class="fas fa-truck text-success me-2"></i>Mark as Shipped
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('${order.id}', 'cancelled')">
                                        <i class="fas fa-times text-danger me-2"></i>Mark as Cancelled
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'status-pending';
                case 'shipped': return 'status-shipped';
                case 'cancelled': return 'status-cancelled';
                default: return 'status-pending';
            }
        }

        function updateOrderStatus(orderId, newStatus) {
            const orderIndex = orders.findIndex(order => order.id === orderId);
            if (orderIndex !== -1) {
                orders[orderIndex].status = newStatus;
                localStorage.setItem('tictacbags_orders', JSON.stringify(orders));
                loadOrders(); // Refresh the display
                showNotification(`Order ${orderId} status updated to ${newStatus}`, 'success');
            }
        }

        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const orderDate = new Date(order.date).toLocaleString();
            const statusClass = getStatusClass(order.status);

            let itemsHTML = '';
            order.items.forEach(item => {
                itemsHTML += `
                    <tr>
                        <td>${item.title}</td>
                        <td>${item.quantity}</td>
                        <td>Rs ${item.price.toLocaleString()}</td>
                        <td>Rs ${(item.price * item.quantity).toLocaleString()}</td>
                    </tr>
                `;
            });

            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Order Information</h6>
                        <p><strong>Order ID:</strong> ${order.id}</p>
                        <p><strong>Date:</strong> ${orderDate}</p>
                        <p><strong>Status:</strong> <span class="order-status ${statusClass}">${order.status}</span></p>
                        <p><strong>Payment Method:</strong> ${order.paymentMethod.toUpperCase()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Customer Information</h6>
                        <p><strong>Name:</strong> ${order.customerName}</p>
                        <p><strong>Email:</strong> ${order.email}</p>
                        <p><strong>Phone:</strong> ${order.phone}</p>
                        <p><strong>Address:</strong> ${order.address}</p>
                        ${order.instructions ? `<p><strong>Instructions:</strong> ${order.instructions}</p>` : ''}
                    </div>
                </div>
                <hr>
                <h6 class="fw-bold mb-3">Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span>Rs ${order.subtotal.toLocaleString()}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Shipping:</span>
                            <span>Rs ${order.shipping.toLocaleString()}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total:</span>
                            <span>Rs ${order.total.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('orderDetailsContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
        }

        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            
            filteredOrders = orders.filter(order => {
                let matchesStatus = !statusFilter || order.status === statusFilter;
                let matchesDate = !dateFrom || new Date(order.date) >= new Date(dateFrom);
                
                return matchesStatus && matchesDate;
            });
            
            currentPage = 1;
            displayOrders();
            updatePagination();
        }

        function searchOrders() {
            const searchTerm = document.getElementById('searchOrders').value.toLowerCase();
            
            if (!searchTerm) {
                filteredOrders = [...orders];
            } else {
                filteredOrders = orders.filter(order => 
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.customerName.toLowerCase().includes(searchTerm) ||
                    order.email.toLowerCase().includes(searchTerm) ||
                    order.phone.includes(searchTerm)
                );
            }
            
            currentPage = 1;
            displayOrders();
            updatePagination();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchOrders').value = '';
            document.getElementById('dateFrom').value = '';
            filteredOrders = [...orders];
            currentPage = 1;
            displayOrders();
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            const pagination = document.getElementById('ordersPagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">Previous</a>
                </li>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${currentPage === i ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">Next</a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayOrders();
                updatePagination();
            }
        }

        function refreshOrders() {
            loadOrders();
            showNotification('Orders refreshed successfully!', 'info');
        }

        function exportOrders() {
            if (orders.length === 0) {
                showNotification('No orders to export', 'warning');
                return;
            }

            const csvContent = generateOrdersCSV();
            downloadCSV(csvContent, 'tictacbags-orders.csv');
            showNotification('Orders exported successfully!', 'success');
        }

        function generateOrdersCSV() {
            const headers = ['Order ID', 'Customer Name', 'Email', 'Phone', 'Total', 'Status', 'Payment Method', 'Date'];
            const rows = orders.map(order => [
                order.id,
                order.customerName,
                order.email,
                order.phone,
                order.total.toFixed(2),
                order.status,
                order.paymentMethod.toUpperCase(),
                new Date(order.date).toLocaleString()
            ]);

            return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Test function to add a sample order (for debugging)
        function addTestOrder() {
            const testOrder = {
                id: 'TTB' + Date.now().toString().slice(-8),
                customerName: 'Test Customer',
                email: 'test@example.com',
                phone: '03211334879',
                city: 'karachi',
                address: 'Test Address, Karachi',
                instructions: 'Test order',
                paymentMethod: 'cod',
                items: [{
                    id: 1,
                    title: 'Test Product',
                    price: 5000,
                    quantity: 1
                }],
                subtotal: 5000,
                shipping: 200,
                total: 5200,
                status: 'pending',
                date: new Date().toISOString()
            };
            
            const existingOrders = JSON.parse(localStorage.getItem('tictacbags_orders')) || [];
            existingOrders.push(testOrder);
            localStorage.setItem('tictacbags_orders', JSON.stringify(existingOrders));
            
            console.log('Test order added:', testOrder);
            loadOrders(); // Refresh the display
            showNotification('Test order added successfully!', 'success');
        }
        
        // Add test button to the page (run in console: addTestOrderButton())
        function addTestOrderButton() {
            const button = document.createElement('button');
            button.className = 'btn btn-warning btn-sm';
            button.innerHTML = '<i class="fas fa-plus me-1"></i>Add Test Order';
            button.onclick = addTestOrder;
            document.querySelector('.admin-content .d-flex').appendChild(button);
        }

        // Auto-refresh orders every 30 seconds
        setInterval(() => {
            loadOrders();
        }, 30000);
    </script>
</body>
</html>