<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Categories Management - TicTacBags Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0">
                <div class="admin-sidebar">
                    <!-- Admin Brand -->
                    <div class="text-center mb-4">
                        <h4 class="text-white fw-bold">
                            <i class="fas fa-shopping-bag me-2"></i>TicTacBags
                        </h4>
                        <p class="text-white-50 small mb-0">Admin Panel</p>
                    </div>

                    <!-- Admin User Info -->
                    <div class="text-center mb-4 pb-3 border-bottom border-secondary">
                        <div class="bg-white bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <h6 class="text-white mb-1">Administrator</h6>
                        <small class="text-white-50" id="loginTime"></small>
                    </div>

                    <!-- Navigation Menu -->
                    <ul class="admin-nav">
                        <li>
                            <a href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i>
                                Orders Management
                            </a>
                        </li>
                        <li>
                            <a href="products.html">
                                <i class="fas fa-box"></i>
                                Products Management
                            </a>
                        </li>
                        <li>
                            <a href="categories.html" class="active">
                                <i class="fas fa-list"></i>
                                Categories Management
                            </a>
                        </li>
                        <li>
                            <a href="brands.html">
                                <i class="fas fa-tags"></i>
                                Brands Management
                            </a>
                        </li>
                        <li>
                            <a href="banners.html">
                                <i class="fas fa-images"></i>
                                Banner Management
                            </a>
                        </li>
                        <li>
                            <a href="../index.html" target="_blank">
                                <i class="fas fa-external-link-alt"></i>
                                View Website
                            </a>
                        </li>
                        <li class="mt-4">
                            <a href="#" onclick="logout()" class="text-danger">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="admin-content">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="fw-bold text-dark">Categories Management</h1>
                            <p class="text-muted">Manage product categories and their filters</p>
                        </div>
                        <div>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                <i class="fas fa-plus me-2"></i>Add Category
                            </button>
                        </div>
                    </div>

                    <!-- Categories Stats -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="admin-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded p-3 me-3">
                                        <i class="fas fa-list text-primary" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-1" id="totalCategories">0</h3>
                                        <p class="text-muted mb-0 small">Total Categories</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="admin-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-opacity-10 rounded p-3 me-3">
                                        <i class="fas fa-eye text-success" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold mb-1" id="activeCategories">0</h3>
                                        <p class="text-muted mb-0 small">Active Categories</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categories Table -->
                    <div class="admin-card">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Category Name</th>
                                        <th>Status</th>
                                        <th>Products Count</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesTableBody">
                                    <!-- Categories will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- No Categories Message -->
                        <div id="noCategoriesMessage" class="text-center py-5 d-none">
                            <i class="fas fa-list text-muted" style="font-size: 3rem;"></i>
                            <h4 class="mt-3 mb-2">No categories found</h4>
                            <p class="text-muted mb-3">Create your first category to organize products</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                <i class="fas fa-plus me-2"></i>Add Category
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name *</label>
                            <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="categoryActive" name="categoryActive" checked>
                                <label class="form-check-label" for="categoryActive">
                                    Active (visible on website)
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm">
                        <input type="hidden" id="editCategoryId" name="editCategoryId">
                        <div class="mb-3">
                            <label for="editCategoryName" class="form-label">Category Name *</label>
                            <input type="text" class="form-control" id="editCategoryName" name="editCategoryName" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editCategoryActive" name="editCategoryActive">
                                <label class="form-check-label" for="editCategoryActive">
                                    Active (visible on website)
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateCategory()">Update Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../js/main.js"></script>

    <script>
        // Categories management variables
        let categories = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadCategories();
            updateLoginTime();
        });

        function checkAdminAuth() {
            const loginData = localStorage.getItem('tictacbags_admin_login');
            if (!loginData) {
                window.location.href = 'index.html';
                return;
            }

            const data = JSON.parse(loginData);
            const now = new Date().getTime();
            const sessionDuration = data.rememberMe ? (24 * 60 * 60 * 1000) : (60 * 60 * 1000);
            
            if ((now - data.timestamp) > sessionDuration) {
                localStorage.removeItem('tictacbags_admin_login');
                window.location.href = 'index.html';
                return;
            }
        }

        function updateLoginTime() {
            const loginData = localStorage.getItem('tictacbags_admin_login');
            if (loginData) {
                const data = JSON.parse(loginData);
                const loginDate = new Date(data.timestamp);
                document.getElementById('loginTime').textContent = loginDate.toLocaleString();
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('tictacbags_admin_login');
                window.location.href = 'index.html';
            }
        }

        function loadCategories() {
            // Load categories from localStorage
            categories = JSON.parse(localStorage.getItem('tictacbags_categories')) || [];
            
            // If no categories exist, create default ones
            if (categories.length === 0) {
                categories = [
                    { id: 1, name: "Backpacks", active: true, createdDate: new Date().toISOString() },
                    { id: 2, name: "Handbags", active: true, createdDate: new Date().toISOString() },
                    { id: 3, name: "Travel Bags", active: true, createdDate: new Date().toISOString() },
                    { id: 4, name: "Laptop Bags", active: true, createdDate: new Date().toISOString() },
                    { id: 5, name: "Tote Bags", active: true, createdDate: new Date().toISOString() },
                    { id: 6, name: "Sports Bags", active: true, createdDate: new Date().toISOString() }
                ];
                localStorage.setItem('tictacbags_categories', JSON.stringify(categories));
            }
            
            updateCategoryStats();
            displayCategories();
        }

        function updateCategoryStats() {
            const totalCategories = categories.length;
            const activeCategories = categories.filter(c => c.active).length;

            document.getElementById('totalCategories').textContent = totalCategories;
            document.getElementById('activeCategories').textContent = activeCategories;
        }

        function displayCategories() {
            const tbody = document.getElementById('categoriesTableBody');
            const noCategoriesMsg = document.getElementById('noCategoriesMessage');
            
            if (categories.length === 0) {
                tbody.innerHTML = '';
                noCategoriesMsg.classList.remove('d-none');
                return;
            }

            noCategoriesMsg.classList.add('d-none');
            tbody.innerHTML = '';

            categories.forEach(category => {
                const productsCount = getProductsCountForCategory(category.name);
                const createdDate = new Date(category.createdDate).toLocaleDateString();
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>#${category.id}</strong></td>
                    <td>${category.name}</td>
                    <td>
                        <span class="badge ${category.active ? 'bg-success' : 'bg-secondary'}">
                            ${category.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${productsCount} products</td>
                    <td>${createdDate}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editCategory(${category.id})" title="Edit Category">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-${category.active ? 'secondary' : 'success'}" 
                                    onclick="toggleCategoryStatus(${category.id})" 
                                    title="${category.active ? 'Deactivate' : 'Activate'} Category">
                                <i class="fas fa-${category.active ? 'eye-slash' : 'eye'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteCategory(${category.id})" title="Delete Category">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getProductsCountForCategory(categoryName) {
            const products = JSON.parse(localStorage.getItem('tictacbags_products')) || [];
            return products.filter(p => p.category === categoryName).length;
        }

        function saveCategory() {
            const form = document.getElementById('addCategoryForm');
            const formData = new FormData(form);
            
            const categoryName = formData.get('categoryName').trim();
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            // Check if category already exists
            if (categories.some(c => c.name.toLowerCase() === categoryName.toLowerCase())) {
                alert('Category already exists!');
                return;
            }

            const newCategory = {
                id: Date.now(),
                name: categoryName,
                active: formData.get('categoryActive') === 'on',
                createdDate: new Date().toISOString()
            };

            categories.push(newCategory);
            localStorage.setItem('tictacbags_categories', JSON.stringify(categories));
            
            // Close modal and refresh
            bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
            form.reset();
            loadCategories();
            
            showNotification('Category added successfully!', 'success');
        }

        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryActive').checked = category.active;

            new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
        }

        function updateCategory() {
            const form = document.getElementById('editCategoryForm');
            const formData = new FormData(form);
            
            const categoryId = parseInt(formData.get('editCategoryId'));
            const categoryName = formData.get('editCategoryName').trim();
            
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            // Check if category name already exists (excluding current category)
            if (categories.some(c => c.id !== categoryId && c.name.toLowerCase() === categoryName.toLowerCase())) {
                alert('Category name already exists!');
                return;
            }

            const categoryIndex = categories.findIndex(c => c.id === categoryId);
            if (categoryIndex !== -1) {
                const oldName = categories[categoryIndex].name;
                categories[categoryIndex].name = categoryName;
                categories[categoryIndex].active = formData.get('editCategoryActive') === 'on';
                
                // Update products that use this category
                updateProductsCategory(oldName, categoryName);
                
                localStorage.setItem('tictacbags_categories', JSON.stringify(categories));
                
                // Close modal and refresh
                bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
                loadCategories();
                
                showNotification('Category updated successfully!', 'success');
            }
        }

        function updateProductsCategory(oldName, newName) {
            if (oldName === newName) return;
            
            const products = JSON.parse(localStorage.getItem('tictacbags_products')) || [];
            const updatedProducts = products.map(product => {
                if (product.category === oldName) {
                    product.category = newName;
                }
                return product;
            });
            localStorage.setItem('tictacbags_products', JSON.stringify(updatedProducts));
        }

        function toggleCategoryStatus(categoryId) {
            const categoryIndex = categories.findIndex(c => c.id === categoryId);
            if (categoryIndex !== -1) {
                categories[categoryIndex].active = !categories[categoryIndex].active;
                localStorage.setItem('tictacbags_categories', JSON.stringify(categories));
                loadCategories();
                
                const status = categories[categoryIndex].active ? 'activated' : 'deactivated';
                showNotification(`Category ${status} successfully!`, 'success');
            }
        }

        function deleteCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            const productsCount = getProductsCountForCategory(category.name);
            let confirmMessage = `Are you sure you want to delete "${category.name}"?`;
            
            if (productsCount > 0) {
                confirmMessage += `\n\nWarning: ${productsCount} products are using this category. They will be set to "Uncategorized".`;
            }

            if (confirm(confirmMessage)) {
                // Remove category
                categories = categories.filter(c => c.id !== categoryId);
                localStorage.setItem('tictacbags_categories', JSON.stringify(categories));
                
                // Update products that use this category
                if (productsCount > 0) {
                    updateProductsCategory(category.name, 'Uncategorized');
                }
                
                loadCategories();
                showNotification('Category deleted successfully!', 'success');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>
</body>
</html>